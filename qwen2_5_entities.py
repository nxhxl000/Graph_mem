import requests
import json
from textwrap import dedent

OLLAMA_URL = "http://localhost:11434/api/generate"
MODEL_NAME = "deepseek-r1:8b-0528-qwen3-fp16"  # замени на точное имя модели в ollama, если нужно


PROMPT_HEADER = dedent("""
Ты — система предобработки текста на русском языке.

Задача:
1. Принять исходный текст (на русском).
2. Разбить его на предложения.
3. Для каждого предложения:
   - присвоить уникальный идентификатор предложения `sent_id` в формате "s1", "s2", "s3" и т.д., в порядке следования предложений в тексте;
   - выделить сущности (entities), которые важны для понимания текста:
     • имена собственные (люди, организации, компании, географические объекты и т.п.);
     • материалы, вещества, сплавы, химические соединения;
     • процессы, технологии, методы, оборудование;
     • другие значимые предметные термины (существительные или устойчивые словосочетания).
4. Для каждой сущности:
   - присвоить уникальный идентификатор `entity_id`, в котором ДОЛЖЕН присутствовать `sent_id` предложения, например: "s1_e1", "s1_e2", "s2_e1" и т.д.;
   - указать точный текст сущности так, как он встречается в предложении (поле `text`);
   - по возможности кратко указать тип сущности (поле `type`), например: "PERSON", "ORG", "LOCATION", "SUBSTANCE", "TECHNOLOGY", "PROCESS", "EQUIPMENT", "OTHER".

Требования к разбиению на предложения:
- Используй стандартные правила русского языка: предложения заканчиваются на ".", "!", "?", а также на сочетания вроде "... .".
- Сохраняй порядок предложений.
- Если в тексте есть заголовки/подзаголовки, тоже считай их предложениями и обрабатывай.

Формат ответа:
Верни СТРОГО один JSON-объект без какого-либо дополнительного текста до или после него.

Структура JSON:
{
  "sentences": [
    {
      "sent_id": "s1",
      "text": "Текст первого предложения.",
      "entities": [
        {
          "entity_id": "s1_e1",
          "text": "Пример сущности",
          "type": "ORG"
        },
        {
          "entity_id": "s1_e2",
          "text": "Кобальт",
          "type": "SUBSTANCE"
        }
      ]
    },
    {
      "sent_id": "s2",
      "text": "Текст второго предложения.",
      "entities": [
        {
          "entity_id": "s2_e1",
          "text": "Россия",
          "type": "LOCATION"
        }
      ]
    }
  ]
}

Обязательные условия:
- Ответ должен быть валидным JSON.
- Используй только двойные кавычки в JSON.
- Не добавляй комментарии, пояснения, текст вне JSON.
- Если в каком-то предложении нет сущностей, верни для него "entities": [].

Исходный текст для обработки:
""")


def build_prompt(text: str) -> str:
    """
    Склеиваем инструкции и исходный текст.
    Здесь ничего форматом не ломаем, просто добавляем текст после промпта.
    """
    return PROMPT_HEADER + "\n" + text.strip() + "\n"


def extract_sentences_and_entities(text: str):
    """
    Отправляет текст в локальную модель Qwen2.5 через Ollama
    и возвращает распарсенный JSON с предложениями и сущностями.
    """
    prompt = build_prompt(text)

    payload = {
        "model": MODEL_NAME,
        "prompt": prompt,
        "stream": False,
        "options": {
            "temperature": 0.0
        }
    }

    resp = requests.post(OLLAMA_URL, json=payload, timeout=600)
    resp.raise_for_status()

    data = resp.json()
    raw_response = data.get("response", "").strip()

    # Пытаемся распарсить как JSON
    try:
        result = json.loads(raw_response)
    except json.JSONDecodeError as e:
        print("❌ Не удалось распарсить JSON из ответа модели.")
        print("Ошибка:", e)
        print("Сырой ответ модели:\n", raw_response)
        raise

    return result


if __name__ == "__main__":
    # Пример: сюда подставь свой текст (можно читать из файла)
    sample_text = """
В современном мире кобальт, его сплавы и соединения получили применение в различных отраслях техники и народного хозяйства. Это жаропрочные, износостойкие, инструментальные стали, так называемые суперсплавы, магнитные материалы, химические соединения, используемые в производстве катализаторов, красителей, осушителей, медицинских препаратов, удобрений.

В бывшнем СССР применение кобальта ограничивалось в основном потребностями военно-промышленного комплекса. Глубокие изменения в международной обстановке в последнее десятилетие XX века вызывают сокращение производства военной техники в мире и снижение потребления кобальта в соответствующих отраслях.

Однако специалисты прогнозируют сохранение устойчивого уровня потребления кобальта за счет увеличения производства солей для получения катализаторов, используемых при нефтепереработке, приготовления пластмасс, в других химических технологиях, а также красителей и пигментов для приготовления красок, эмалей, глазури для керамики, реактивов для пищевой, медицинской промышленности. Использование кобальта в производстве сплавов и магнитов также не потеряет своего значения.

Этот вывод подкрепляется повышением мировой цены на кобальт с начала 90-х годов. Кобальтовое производство организовано во многих странах: в США, Канаде, Бельгии, Франции, Финляндии оно основано на персеработке богатых собственных и привозных концентратов, в том числе пиритно-кобальтовых и арсенопиритно-кобальтовых, а также полупродуктов.
    """

    result = extract_sentences_and_entities(sample_text)
    print(json.dumps(result, ensure_ascii=False, indent=2))
